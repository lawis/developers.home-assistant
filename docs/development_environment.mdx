---
title: "设置开发环境"
---

```mdx-code-block
import {useState} from 'react';

export const RepositoryOpener = () => {
  const [value, setValue] = useState(0);
  const repoUrl = `vscode://ms-vscode-remote.remote-containers/cloneInVolume?url=${encodeURIComponent(value)}`;
  return <div>
    <input onInput={(ev) => setValue(ev.target.value)} style={{width: "80%", display: "inline-block", marginRight: 16}} />
    <a href={repoUrl}><button style={{cursor: value == "" ? "default" : "pointer"}} disabled={value == ""}>打开</button></a>
  </div>
}
```

如果您想为 Home Assistant 开发新功能(Feature)或组件(Component)，那么就需要设置开发环境。请继续阅读学习如何设置。

## 使用 Visual Studio Code + devcontainer 开发

开始开发最简单的方法就是使用Visual Studio Code 再加上 devcontainers. 这种方法会创建一个包含所有需要的工具包的开发环境.这种方法适用于所有的Home Assistant仓库.[了解更多关于devcontainers的信息.](https://code.visualstudio.com/docs/devcontainers/containers)


:::note
因为这种方法使用了容器技术,您可能会遇到容器无法挂载宿主机硬件(例如USB设备,蓝牙zigbee适配器等)的问题.在Linux主机上没有此问题,在Windows和Mac OS主机上,会遇到此类问题.
:::

**必要条件**

- [Docker](https://docs.docker.com/get-docker/)
- [Visual Studio code](https://code.visualstudio.com/)
- [Git](https://git-scm.com/)

**快速开始**

1. 打开 [Home Assistant 内核(Core) 仓库](https://github.com/home-assistant/core) 点击 "fork" 按钮.
2. 当复刻(Fork)创建以后,复制复刻(fork)的URL地址并粘贴到以下文本框中,点击"打开"按钮:
   <RepositoryOpener />
3. 浏览器将提示您是否要使用Visual Studio Code打开链接,单机"打开链接".
4. 当 Visual Studio Code 询问您是否要安装远程扩展时，单击"安装".
5. 几分钟以后开发容器(Dev Container)镜像将被构建, 之后开发环境就准备就绪了.
6. 你可以通过以下方式验证开发容器是否已经正确设置:
    * 在Visual Studio Code中打开命令选项面板 - `Shift`+`Command`+`P`(Mac) / `Ctrl`+`Shift`+`P` (Windows/Linux).
    * 选择 `Tasks: Run Task` -> `Run Home Assistant Core`
    * 终端会被打开并开始输出活动信息. 检查是否报错并等待输出停止.
    * 在浏览器中打开 `https://localhost:8123`, 你应该可以看到Home Assistant的设置界面.

后续,如果您想回到开发环境,打开Visual Studio Code,单击侧边栏中的"远程资源管理器",选择和您复刻(fork)仓库对应的容器即可.

### 任务

Devcontainer附带了一些有用的任务来帮助您开发,使用`Shift`+`Command`+`P`(Mac) / `Ctrl`+`Shift`+`P` (Windows/Linux)打开命令面板,输入`Tasks: Run Task`,在选择您需要运行的任务即可.

如果一个任务正在运行(比如文档的`预览(Review)任务`),您希望重启它,可以打开命令面板输入`Tasks: Restart Running Task`,再选择需要重启的任务即可.

### 使用Visual Studio Code进行调试

如果开发容器(Dev Container)设置正确,默认就支持调试.它提供了必要的调试配置,只需要按`F5`键来启动Home Assistant,在代码中设置的断点就会被触发,调试器也会停在这里.

如何需要调试远程的Home Assistant实例(例如 生产实例)也是可以的,只需要根据[这里](https://www.home-assistant.io/integrations/debugpy/)的步骤执行即可.

## Manual Environment

_You only need these instructions if you do not want to use devcontainers._

It is also possible to set up a more traditional development environment. See the section for your operating system. Make sure your Python version is 3.10.

### Developing on Linux

Install the core dependencies.

```shell
sudo apt-get update
sudo apt-get install python3-pip python3-dev python3-venv autoconf libssl-dev libxml2-dev libxslt1-dev libjpeg-dev libffi-dev libudev-dev zlib1g-dev pkg-config libavformat-dev libavcodec-dev libavdevice-dev libavutil-dev libswscale-dev libavresample-dev libavfilter-dev ffmpeg
```

### Developing on Windows

To develop on Windows, you will need to use the Linux subsystem (WSL). Follow the [WSL installation instructions](https://learn.microsoft.com/windows/wsl/install) and install Ubuntu from the Windows Store. Once you're able to access Linux, follow the Linux instructions.

:::tip
If you find that you cannot open the development instance via <http://localhost:8123> when using WSL, instead, within a WSL terminal, find the `inet` address of the `eth0` adaptor by running `ip addr show eth0`. Then use this address, excluding the CIDR block, to access the development instance, i.e. if your `inet` is listed as `172.20.37.6/20`, use <http://172.20.37.6:8123>.
:::

#### Freshly installed WSL distribution

The first time a WSL distribution is started, and the default WSL user account is created, the Windows drives will still be mounted with all files owned by `root:root` instead of owned by the default user, i.e. with `uid=0,gid=0` included in the mount options as shown by:

```bash
user@DESKTOP:/mnt/c/Users/user$ mount | grep mnt
C:\ on /mnt/c type drvfs (rw,noatime,uid=0,gid=0,case=off)
```

This will cause the `setup` script to fail with an unrelated error if the local repository is on a Windows drive. To recover, WSL must be restarted after which the Windows drives will be mounted with all files owned by the default WSL user. This can be accomplished by simply restarting the computer, or by issuing the following command from a windows command prompt:

```bash
wsl --shutdown
```

After WSL is restarted, the mount's uid and gid will match the default user.

### Developing on macOS

Install [Homebrew](https://brew.sh/), then use that to install the dependencies:

```shell
brew install python3 autoconf ffmpeg cmake
```

If you encounter build issues with `cryptography` when running the `script/setup` script below, check the cryptography documentation for [installation instructions](https://cryptography.io/en/latest/installation/#building-cryptography-on-macos).

## Setup Local Repository

Visit the [Home Assistant Core repository](https://github.com/home-assistant/core) and click **Fork**.
Once forked, setup your local copy of the source using the commands:

```shell
git clone https://github.com/YOUR_GIT_USERNAME/core.git
cd core
git remote add upstream https://github.com/home-assistant/core.git
```

Install the requirements with a provided script named `setup`.

```shell
script/setup
```

This will create a virtual environment and install all necessary requirements. You're now set!

Each time you start a new terminal session, you will need to activate your virtual environment:

```shell
source venv/bin/activate
```

After that you can run Home Assistant like this:

```shell
hass -c config
```

If you encounter a crash (`SIGKILL`) while running this command on *macOS*, it's probably about lack of Bluetooth permission. You can fix it by adding this permission for your Terminal app (System Preferences -> Security & Privacy -> Bluetooth).

The Home Assistant configuration is stored in the `config` directory in your repository.
